<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.agileboot.domain.biz.statistics.db.StatisticsMapper">

    <select id="getStatisticsByTime" resultType="com.agileboot.domain.biz.statistics.dto.StatisticsByTimeDTO">
        SELECT
            b.create_time,
            b.amount,
            b.type,
            b.customer_name,
            c.phone as customer_phone,
            b.operate_user_name as operator,
            d.dept_name,
            att.serial_num,
            att.attachment,
            att.product
        FROM
            biz_balance_log b
            LEFT JOIN biz_balance_log_att att ON b.id = att.log_id
            LEFT JOIN biz_customer c on b.customer_id = c.id
            LEFT JOIN sys_user u on b.operate_user_id = u.user_id
            LEFT JOIN sys_dept d on u.dept_id = d.dept_id
        <where>
            <if test="param.beginTime != null">
                AND b.create_time >= #{param.beginTime}
            </if>
            <if test="param.endTime != null">
                AND b.create_time <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.deptId != null and param.deptId != ''">
                AND (d.dept_id = #{param.deptId}
                <if test="param.includeChildDept != null and param.includeChildDept">
                    or find_in_set(#{param.deptId}, d.ancestors)
                </if>
                )
            </if>
            <if test="param.type != null">
                AND b.type = #{param.type}
            </if>
        </where>
        order by b.create_time desc
    </select>
</mapper>
